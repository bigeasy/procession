<!DOCTYPE html>

<html>
<head>
  <title>procession.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>

      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">


                <a class="source" href="counter.js.html">
                  counter.js
                </a>


                <a class="source" href="deferred.js.html">
                  deferred.js
                </a>


                <a class="source" href="heft.js.html">
                  heft.js
                </a>


                <a class="source" href="identifier.js.html">
                  identifier.js
                </a>


                <a class="source" href="indexer.js.html">
                  indexer.js
                </a>


                <a class="source" href="node.js.html">
                  node.js
                </a>


                <a class="source" href="procession.js.html">
                  procession.js
                </a>


                <a class="source" href="shifter.js.html">
                  shifter.js
                </a>


                <a class="source" href="throttle.js.html">
                  throttle.js
                </a>

            </div>
          </div>
        </li>
      </ul>

    <ul class="sections">

          <li id="title">
              <div class="annotation">
                  <h1>procession.js</h1>
              </div>
          </li>



        <li id="section-1">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>One thing to note in the documentation is that this Queue and all my envelope
based classes are unapologetically partial to <code>switch</code> statements. There
are probably some articles out there about how they are considered harmful
and how opaque and esoteric function dispatch lookup tables are superior.
What is the nature of that reasoning? Because <code>goto</code> was harmful, other
keywords are looking pretty shady now too?</p>

            </div>

        </li>


        <li id="section-2">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Common utilities.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert'</span>)</pre></div></div>

        </li>


        <li id="section-3">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Control-flow utilities.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> abend = <span class="hljs-built_in">require</span>(<span class="hljs-string">'abend'</span>)
<span class="hljs-keyword">var</span> cadence = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cadence'</span>)</pre></div></div>

        </li>


        <li id="section-4">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>User specified callback wrapper.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Operation = <span class="hljs-built_in">require</span>(<span class="hljs-string">'operation'</span>)</pre></div></div>

        </li>


        <li id="section-5">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Evented semaphore.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Signal = <span class="hljs-built_in">require</span>(<span class="hljs-string">'signal'</span>)</pre></div></div>

        </li>


        <li id="section-6">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Serial value that wraps at <code>0xffffffff</code>.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Identifier = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./identifier'</span>)</pre></div></div>

        </li>


        <li id="section-7">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Iterator used to consume values in the evented queue.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Shifter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./shifter'</span>)</pre></div></div>

        </li>


        <li id="section-8">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Queue entry node.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Node = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./node'</span>)</pre></div></div>

        </li>


        <li id="section-9">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Delays the invocation of a listenerâ€™s <code>shifted</code> method until a node created
after the listener was added is shifted.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Deferred = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./deferred'</span>)</pre></div></div>

        </li>


        <li id="section-10">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>A listener that keeps count of the values in the queue.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Counter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./counter'</span>)</pre></div></div>

        </li>


        <li id="section-11">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Orderly destruction of complicated objects.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Destructor = <span class="hljs-built_in">require</span>(<span class="hljs-string">'nascent.destructor'</span>)</pre></div></div>

        </li>


        <li id="section-12">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Exceptions with context.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> interrupt = <span class="hljs-built_in">require</span>(<span class="hljs-string">'interrupt'</span>).createInterrupter(<span class="hljs-string">'procession'</span>)</pre></div></div>

        </li>


        <li id="section-13">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Construct a queue.</p>

            </div>

        </li>


        <li id="section-14">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Procession</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">this</span>._listeners = []
    <span class="hljs-keyword">this</span>._undecorated = []
    <span class="hljs-keyword">this</span>._consumers = []

    <span class="hljs-keyword">this</span>._identifier = <span class="hljs-keyword">new</span> Identifier

    <span class="hljs-keyword">this</span>.head = <span class="hljs-keyword">new</span> Node(<span class="hljs-keyword">this</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>)

    <span class="hljs-keyword">this</span>.pushed = <span class="hljs-keyword">new</span> Signal
    <span class="hljs-keyword">this</span>.shifted = <span class="hljs-keyword">new</span> Signal

    <span class="hljs-keyword">this</span>.addListener(<span class="hljs-keyword">new</span> Counter())

    <span class="hljs-keyword">this</span>._follower = <span class="hljs-keyword">this</span>.shifter()
}</pre></div></div>

        </li>


        <li id="section-15">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Node and Shifter modules reference each other so we provide this Shifter
constructor to the Node class since it wonâ€™t be able to git it using
<code>require</code>.</p>
<hr>

            </div>

        </li>


        <li id="section-16">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre>Procession.prototype._Shifter = Shifter</pre></div></div>

        </li>


        <li id="section-17">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Add a listener that can track values as they are enqueued and dequeued. The
listenerâ€™s push and shift methods  will only be invoked for values enqueued
after it is added to to the procession.</p>
<hr>

            </div>

        </li>


        <li id="section-18">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>

            </div>

        </li>


        <li id="section-19">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>We decorate the listener with a deferred decorator. We keep a parallel arrays
of undecorated listeners do we can find its array index if weâ€™re asked to
remove it before it undecorates itself.</p>

            </div>

            <div class="content"><div class='highlight'><pre>Procession.prototype.addListener = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">listener</span>) </span>{
    listener.added(<span class="hljs-keyword">this</span>)
    <span class="hljs-keyword">this</span>._undecorated.push(listener)
    <span class="hljs-keyword">this</span>._listeners.push(<span class="hljs-keyword">new</span> Deferred(<span class="hljs-keyword">this</span>, listener))
}</pre></div></div>

        </li>


        <li id="section-20">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Remove a listener.</p>
<hr>

            </div>

        </li>


        <li id="section-21">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre>Procession.prototype.removeListener = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">listener</span>) </span>{
    <span class="hljs-keyword">var</span> index = <span class="hljs-keyword">this</span>._undecorated.indexOf(<span class="hljs-keyword">this</span>)
    <span class="hljs-keyword">this</span>._undecorated.splice(index, <span class="hljs-number">1</span>)
    <span class="hljs-keyword">this</span>._listeners.splice(index, <span class="hljs-number">1</span>)
    listener.removed(<span class="hljs-keyword">this</span>)
}</pre></div></div>

        </li>


        <li id="section-22">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Create a new shifter to consume enqueued entries. Begins with entries added
after the creation of the cosumer.</p>
<hr>

            </div>

        </li>


        <li id="section-23">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre>Procession.prototype.shifter = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Shifter(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.head)
}</pre></div></div>

        </li>


        <li id="section-24">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Push an entry or push an error or else push <code>null</code> to indicate end of stream.</p>

            </div>

        </li>


        <li id="section-25">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre>Procession.prototype.push = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">value</span>) </span>{</pre></div></div>

        </li>


        <li id="section-26">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>You can only push an end of stream <code>null</code> after end of stream.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.endOfStream) {
        <span class="hljs-keyword">return</span>
    }
    <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">this</span>.head = <span class="hljs-keyword">this</span>.head.next = <span class="hljs-keyword">new</span> Node(<span class="hljs-keyword">this</span>, <span class="hljs-literal">null</span>, value, <span class="hljs-literal">null</span>)
        <span class="hljs-keyword">this</span>.endOfStream = <span class="hljs-literal">true</span>
    } <span class="hljs-keyword">else</span> {</pre></div></div>

        </li>


        <li id="section-27">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Otherwise, add the entry and notify listeners.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.head = <span class="hljs-keyword">this</span>.head.next = <span class="hljs-keyword">new</span> Node(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>._identifier.next(), value, <span class="hljs-literal">null</span>)
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, I = <span class="hljs-keyword">this</span>._listeners.length; i &lt; I; i++) {
            <span class="hljs-keyword">this</span>._listeners[i].pushed(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.head)
        }
    }</pre></div></div>

        </li>


        <li id="section-28">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Notify any waiting consumers, or anyone else waiting on a push.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.pushed.notify(<span class="hljs-literal">null</span>, <span class="hljs-literal">true</span>)</pre></div></div>

        </li>


        <li id="section-29">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Shift our dummy shifter to trigger cleanup if no one else is listening.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>._follower.shift()
}</pre></div></div>

        </li>


        <li id="section-30">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Called by Consumers as they advance.</p>

            </div>

        </li>


        <li id="section-31">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre>Procession.prototype._shifted = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">node</span>) </span>{
    <span class="hljs-keyword">if</span> (node.body == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span>
    }
    <span class="hljs-keyword">var</span> lesser = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, I = <span class="hljs-keyword">this</span>._consumers.length; i &lt; I; i++) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._identifier.compare(<span class="hljs-keyword">this</span>._consumers[i].node.id, node.id) &lt; <span class="hljs-number">0</span>) {
            lesser++
        }
    }
    <span class="hljs-keyword">if</span> (lesser == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, I = <span class="hljs-keyword">this</span>._listeners.length; i &lt; I; i++) {
            <span class="hljs-keyword">this</span>._listeners[i].shifted(<span class="hljs-keyword">this</span>, node)
        }</pre></div></div>

        </li>


        <li id="section-32">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>We null <code>body</code>, but do not get the bright idea to null <code>id</code>. It is
our deferred listener boundary.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        node.value = <span class="hljs-literal">null</span>
        <span class="hljs-keyword">this</span>.shifted.notify(<span class="hljs-literal">null</span>, <span class="hljs-literal">true</span>)
    }
}

Procession.prototype.enqueue = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async, value</span>) </span>{
    <span class="hljs-keyword">this</span>.push(value)
    <span class="hljs-keyword">return</span> []
})

Procession.prototype.join = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async, condition</span>) </span>{
    <span class="hljs-keyword">var</span> shifter = <span class="hljs-keyword">this</span>.shifter()
    <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        shifter.join(condition, <span class="hljs-keyword">async</span>())
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">value</span>) </span>{
        shifter.destroy()
        <span class="hljs-keyword">return</span> [ value ]
    })
})

Procession.prototype.pump = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">next</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.shifter().pump(next)
}

<span class="hljs-built_in">module</span>.exports = Procession</pre></div></div>

        </li>

    </ul>
  </div>
</body>
</html>
