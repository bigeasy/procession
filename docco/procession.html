<!DOCTYPE html>

<html>
<head>
  <title>procession.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>

      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">


                <a class="source" href="consumer.html">
                  consumer.js
                </a>


                <a class="source" href="counter.html">
                  counter.js
                </a>


                <a class="source" href="deferred.html">
                  deferred.js
                </a>


                <a class="source" href="heft.html">
                  heft.js
                </a>


                <a class="source" href="identifier.html">
                  identifier.js
                </a>


                <a class="source" href="index.html">
                  index.js
                </a>


                <a class="source" href="node.html">
                  node.js
                </a>


                <a class="source" href="procession.html">
                  procession.js
                </a>


                <a class="source" href="throttle.html">
                  throttle.js
                </a>

            </div>
          </div>
        </li>
      </ul>

    <ul class="sections">

          <li id="title">
              <div class="annotation">
                  <h1>procession.js</h1>
              </div>
          </li>



        <li id="section-1">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Operation = <span class="hljs-built_in">require</span>(<span class="hljs-string">'operation'</span>)
<span class="hljs-keyword">var</span> cadence = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cadence'</span>)
<span class="hljs-keyword">var</span> abend = <span class="hljs-built_in">require</span>(<span class="hljs-string">'abend'</span>)
<span class="hljs-keyword">var</span> Identifier = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./identifier'</span>)
<span class="hljs-keyword">var</span> Consumer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./consumer'</span>)
<span class="hljs-keyword">var</span> Node = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./node'</span>)
<span class="hljs-keyword">var</span> Vestibule = <span class="hljs-built_in">require</span>(<span class="hljs-string">'vestibule'</span>)
<span class="hljs-keyword">var</span> Deferred = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./deferred'</span>)
<span class="hljs-keyword">var</span> Counter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./counter'</span>)

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Procession</span> (<span class="hljs-params">options</span>) </span>{
    options || (options = {})
    <span class="hljs-keyword">this</span>._listeners = []
    <span class="hljs-keyword">this</span>._undecorated = []
    <span class="hljs-keyword">this</span>._consumers = []
    <span class="hljs-keyword">this</span>._identifier = <span class="hljs-keyword">new</span> Identifier
    <span class="hljs-keyword">this</span>.pushed = <span class="hljs-keyword">new</span> Vestibule
    <span class="hljs-keyword">this</span>.shifted = <span class="hljs-keyword">new</span> Vestibule
    <span class="hljs-keyword">this</span>.head = <span class="hljs-keyword">new</span> Node(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>._identifier.next(), <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>)
    <span class="hljs-keyword">this</span>._property = options.property || <span class="hljs-string">'size'</span>
    <span class="hljs-keyword">this</span>.addListener(<span class="hljs-keyword">new</span> Counter())
    <span class="hljs-keyword">this</span>._follower = <span class="hljs-keyword">this</span>.consumer()
    <span class="hljs-keyword">this</span>.EndOfStream = Procession.EndOfStream
}

Procession.EndOfStream = {}

</pre></div></div>

        </li>


        <li id="section-2">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>TODO Add a decorator that will ensure that the listener is only activated for
values greater than the least value, the current value of the head. Once the
older values are shifted, the decorator is removed.</p>

            </div>

            <div class="content"><div class='highlight'><pre>Procession.prototype.addListener = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">listener</span>) </span>{
    listener.added(<span class="hljs-keyword">this</span>)
    <span class="hljs-keyword">this</span>._undecorated.push(listener)
    <span class="hljs-keyword">this</span>._listeners.push(<span class="hljs-keyword">new</span> Deferred(<span class="hljs-keyword">this</span>, listener))
}

Procession.prototype.removeListener = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">listener</span>) </span>{
    <span class="hljs-keyword">var</span> index = <span class="hljs-keyword">this</span>._undecorated.indexOf(<span class="hljs-keyword">this</span>)
    <span class="hljs-keyword">this</span>._undecorated.splice(index, <span class="hljs-number">1</span>)
    <span class="hljs-keyword">this</span>._listeners.splice(index, <span class="hljs-number">1</span>)
    listener.removed(procession)
}

Procession.prototype.consumer = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Consumer(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.head)
}

Procession.prototype.push = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">value</span>) </span>{
    <span class="hljs-keyword">this</span>.head = <span class="hljs-keyword">this</span>.head.next = <span class="hljs-keyword">new</span> Node(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>._identifier.next(), value, <span class="hljs-literal">null</span>)
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, I = <span class="hljs-keyword">this</span>._listeners.length; i &lt; I; i++) {
        <span class="hljs-keyword">this</span>._listeners[i].pushed(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.head)
    }
    <span class="hljs-keyword">this</span>.pushed.notify(<span class="hljs-literal">null</span>, <span class="hljs-literal">true</span>)
    <span class="hljs-keyword">this</span>._follower.shift()
}

Procession.prototype._shifted = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">node</span>) </span>{
    <span class="hljs-keyword">var</span> lesser = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, I = <span class="hljs-keyword">this</span>._consumers.length; i &lt; I; i++) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._identifier.compare(<span class="hljs-keyword">this</span>._consumers[i].node.id, node.id) &lt; <span class="hljs-number">0</span>) {
            lesser++
        }
    }
    <span class="hljs-keyword">if</span> (lesser == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, I = <span class="hljs-keyword">this</span>._listeners.length; i &lt; I; i++) {
            <span class="hljs-keyword">this</span>._listeners[i].shifted(<span class="hljs-keyword">this</span>, node)
        }
</pre></div></div>

        </li>


        <li id="section-3">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>node.id = null No! Defer uses this. It is a boundry we must maintain.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        node.value = <span class="hljs-literal">null</span>
        <span class="hljs-keyword">this</span>.shifted.notify(<span class="hljs-literal">null</span>, <span class="hljs-literal">true</span>)
    }
}

Procession.prototype.enqueue = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async, value</span>) </span>{
    <span class="hljs-keyword">this</span>.push(value)
    <span class="hljs-keyword">return</span> []
})

Procession.prototype.join = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async, condition</span>) </span>{
    <span class="hljs-keyword">var</span> consumer = <span class="hljs-keyword">this</span>.consumer()
    <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        consumer.join(condition, <span class="hljs-keyword">async</span>())
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">value</span>) </span>{
        consumer.destroy()
        <span class="hljs-keyword">return</span> [ value ]
    })
})

Procession.prototype.pump = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">next</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.consumer().pump(next)
}

<span class="hljs-built_in">module</span>.exports = Procession

</pre></div></div>

        </li>

    </ul>
  </div>
</body>
</html>
