<!DOCTYPE html>

<html>
<head>
  <title>procession.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>

      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">


                <a class="source" href="consumer.html">
                  consumer.js
                </a>


                <a class="source" href="counter.html">
                  counter.js
                </a>


                <a class="source" href="deferred.html">
                  deferred.js
                </a>


                <a class="source" href="heft.html">
                  heft.js
                </a>


                <a class="source" href="identifier.html">
                  identifier.js
                </a>


                <a class="source" href="index.html">
                  index.js
                </a>


                <a class="source" href="node.html">
                  node.js
                </a>


                <a class="source" href="procession.html">
                  procession.js
                </a>


                <a class="source" href="throttle.html">
                  throttle.js
                </a>

            </div>
          </div>
        </li>
      </ul>

    <ul class="sections">

          <li id="title">
              <div class="annotation">
                  <h1>procession.js</h1>
              </div>
          </li>



        <li id="section-1">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert'</span>)

<span class="hljs-keyword">var</span> cadence = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cadence'</span>)
<span class="hljs-keyword">var</span> abend = <span class="hljs-built_in">require</span>(<span class="hljs-string">'abend'</span>)

<span class="hljs-keyword">var</span> Operation = <span class="hljs-built_in">require</span>(<span class="hljs-string">'operation'</span>)

<span class="hljs-keyword">var</span> Vestibule = <span class="hljs-built_in">require</span>(<span class="hljs-string">'vestibule'</span>)

<span class="hljs-keyword">var</span> Identifier = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./identifier'</span>)
<span class="hljs-keyword">var</span> Consumer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./consumer'</span>)
<span class="hljs-keyword">var</span> Node = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./node'</span>)
<span class="hljs-keyword">var</span> Deferred = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./deferred'</span>)
<span class="hljs-keyword">var</span> Counter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./counter'</span>)

<span class="hljs-keyword">var</span> Destructor = <span class="hljs-built_in">require</span>(<span class="hljs-string">'nascent.destructor'</span>)

<span class="hljs-keyword">var</span> interrupt = <span class="hljs-built_in">require</span>(<span class="hljs-string">'interrupt'</span>).createInterrupter(<span class="hljs-string">'procession'</span>)

</pre></div></div>

        </li>


        <li id="section-2">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Public Procession constructor.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Procession</span> (<span class="hljs-params">options</span>) </span>{
    options || (options = {})

    <span class="hljs-keyword">this</span>._listeners = []
    <span class="hljs-keyword">this</span>._undecorated = []
    <span class="hljs-keyword">this</span>._consumers = []

    <span class="hljs-keyword">this</span>._identifier = <span class="hljs-keyword">new</span> Identifier

    <span class="hljs-keyword">this</span>.head = {
        <span class="hljs-attr">module</span>: <span class="hljs-string">'procession'</span>,
        <span class="hljs-attr">_procession</span>: <span class="hljs-keyword">this</span>,
        <span class="hljs-attr">endOfStream</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">id</span>: <span class="hljs-keyword">this</span>._identifier.next(),
        <span class="hljs-attr">body</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-attr">next</span>: <span class="hljs-literal">null</span>
    }

    <span class="hljs-keyword">this</span>.pushed = <span class="hljs-keyword">new</span> Vestibule
    <span class="hljs-keyword">this</span>.shifted = <span class="hljs-keyword">new</span> Vestibule

    <span class="hljs-keyword">this</span>.addListener(<span class="hljs-keyword">new</span> Counter())

    <span class="hljs-keyword">this</span>._follower = <span class="hljs-keyword">this</span>.consumer()
}

</pre></div></div>

        </li>


        <li id="section-3">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Add a listener that can track values as they are enqueued and dequeued. The
listener’s push and shift methods  will only be invoked for values enqueued
after it is added to to the procession.</p>
<hr>

            </div>

        </li>


        <li id="section-4">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>

            </div>

        </li>


        <li id="section-5">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>We decorate the listener with a deferred decorator. We keep a parallel arrays
of undecorated listeners do we can find its array index if we’re asked to
remove it before it undecorates itself.</p>

            </div>

            <div class="content"><div class='highlight'><pre>Procession.prototype.addListener = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">listener</span>) </span>{
    listener.added(<span class="hljs-keyword">this</span>)
    <span class="hljs-keyword">this</span>._undecorated.push(listener)
    <span class="hljs-keyword">this</span>._listeners.push(<span class="hljs-keyword">new</span> Deferred(<span class="hljs-keyword">this</span>, listener))
}

</pre></div></div>

        </li>


        <li id="section-6">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Remove a listener.</p>
<hr>

            </div>

        </li>


        <li id="section-7">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre>Procession.prototype.removeListener = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">listener</span>) </span>{
    <span class="hljs-keyword">var</span> index = <span class="hljs-keyword">this</span>._undecorated.indexOf(<span class="hljs-keyword">this</span>)
    <span class="hljs-keyword">this</span>._undecorated.splice(index, <span class="hljs-number">1</span>)
    <span class="hljs-keyword">this</span>._listeners.splice(index, <span class="hljs-number">1</span>)
    listener.removed(procession)
}

</pre></div></div>

        </li>


        <li id="section-8">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Create a new consumer to consumer enqueued entries. Begins with entries added
after the creation of the cosumer.</p>
<hr>

            </div>

        </li>


        <li id="section-9">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre>Procession.prototype.consumer = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Consumer(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.head)
}

</pre></div></div>

        </li>


        <li id="section-10">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Interface development. Currently, you push en entry, an error or a <code>null</code> to
indicate end of stream. Simpifies enqueuing. Simplifies pipes because they
can get a switch statement and can tell the difference between an error and
<code>null</code>.</p>

            </div>

        </li>


        <li id="section-11">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Push a value
The values that are shifted are not the values that are pushed. See below.</p>

            </div>

        </li>


        <li id="section-12">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>The shifted value is going to be encased in an object that can be used to
create a swtich statement. non</p>

            </div>

        </li>


        <li id="section-13">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre>Procession.prototype.push = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">value</span>) </span>{
</pre></div></div>

        </li>


        <li id="section-14">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>You can only push an end of stream <code>null</code> after end of stream.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.endOfStream) {
        <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span>
        }
        <span class="hljs-keyword">throw</span> interrupt({ <span class="hljs-attr">name</span>: <span class="hljs-string">'closed'</span> })
    }
    <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Error</span>) {
</pre></div></div>

        </li>


        <li id="section-15">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>If this is an error, we can go ahead add the end of stream <code>null</code> to
ensure that this closes correctly. Simplifies interface on error, the
user doens’t have to remember to send null themselves. They’re no
able to send values after error.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>._consumers.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">consumer</span>) </span>{
            consumer._purge()
        }, <span class="hljs-keyword">this</span>)
        <span class="hljs-keyword">this</span>.head = <span class="hljs-keyword">this</span>.head.next = <span class="hljs-keyword">new</span> Node(<span class="hljs-keyword">this</span>, <span class="hljs-string">'error'</span>, id, value, <span class="hljs-literal">null</span>)
        value = <span class="hljs-literal">null</span>
    }
    <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) {
</pre></div></div>

        </li>


        <li id="section-16">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>If null, we are at th end of stream.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.head = <span class="hljs-keyword">this</span>.head.next = <span class="hljs-keyword">new</span> Node(<span class="hljs-keyword">this</span>, <span class="hljs-string">'end'</span>, id, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>)
        <span class="hljs-keyword">this</span>.endOfStream = <span class="hljs-literal">true</span>
    } <span class="hljs-keyword">else</span> {
</pre></div></div>

        </li>


        <li id="section-17">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Otherwise, add the entry and notify listeners.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.head = <span class="hljs-keyword">this</span>.head.next = <span class="hljs-keyword">new</span> Node(<span class="hljs-keyword">this</span>, <span class="hljs-string">'entry'</span>, id, value, <span class="hljs-literal">null</span>)
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, I = <span class="hljs-keyword">this</span>._listeners.length; i &lt; I; i++) {
            <span class="hljs-keyword">this</span>._listeners[i].pushed(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.head)
        }
    }
</pre></div></div>

        </li>


        <li id="section-18">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Notify any waiting consumers, or anyone else waiting on a push.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.pushed.notify(<span class="hljs-literal">null</span>, <span class="hljs-literal">true</span>)
</pre></div></div>

        </li>


        <li id="section-19">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Shift our dummy consumer to trigger cleanup if no one else is listening.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>._follower.shift()
}

</pre></div></div>

        </li>


        <li id="section-20">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Called by Consumers as they advance.</p>

            </div>

        </li>


        <li id="section-21">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre>Procession.prototype._shifted = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">node</span>) </span>{
    <span class="hljs-keyword">if</span> (node.type != <span class="hljs-string">'entry'</span>) {
        <span class="hljs-keyword">return</span>
    }
    <span class="hljs-keyword">var</span> lesser = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, I = <span class="hljs-keyword">this</span>._consumers.length; i &lt; I; i++) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._identifier.compare(<span class="hljs-keyword">this</span>._consumers[i].node.id, node.id) &lt; <span class="hljs-number">0</span>) {
            lesser++
        }
    }
    <span class="hljs-keyword">if</span> (lesser == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, I = <span class="hljs-keyword">this</span>._listeners.length; i &lt; I; i++) {
            <span class="hljs-keyword">this</span>._listeners[i].shifted(<span class="hljs-keyword">this</span>, node)
        }
</pre></div></div>

        </li>


        <li id="section-22">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>We null <code>body</code>, but do not get the bright idea to null <code>id</code>. It is
our deferred listener boundary.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        node.value = <span class="hljs-literal">null</span>
        <span class="hljs-keyword">this</span>.shifted.notify(<span class="hljs-literal">null</span>, <span class="hljs-literal">true</span>)
    }
}

Procession.prototype.enqueue = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async, value</span>) </span>{
    <span class="hljs-keyword">this</span>.push(value)
    <span class="hljs-keyword">return</span> []
})

Procession.prototype.join = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async, condition</span>) </span>{
    <span class="hljs-keyword">var</span> consumer = <span class="hljs-keyword">this</span>.consumer()
    <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        consumer.join(condition, <span class="hljs-keyword">async</span>())
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">value</span>) </span>{
        consumer.destroy()
        <span class="hljs-keyword">return</span> [ value ]
    })
})

Procession.prototype.pump = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">next</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.consumer().pump(next)
}

<span class="hljs-built_in">module</span>.exports = Procession

</pre></div></div>

        </li>

    </ul>
  </div>
</body>
</html>
